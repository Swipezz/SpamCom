<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/style/styletest.css">
    <title>SpamCom</title>
</head>
<body>
    <div id="container1" class="position-relative">
        <img id="frameimg" src="/static/public/Frame.png" alt="">
        <!-- <img id="garisimg" src="/static/public/Garis.png" alt=""> -->
        <img id="cursor" src="/static/public/Cursor.png" alt="">
        <div id="container2">
            <img id="innerimg" src="/static/public/Inner.png" alt="">
            <div id="grid-container">
                <div id="1" class="grid-item"><div id="btn1" class="follow-element"><img class="mail" src="/static/public/Mail.png" alt=""></div></div>
                <div id="2" class="grid-item"><div id="btn2" class="follow-element"><img class="mail" src="/static/public/Mail.png" alt=""></div></div>
                <div id="3" class="grid-item"><div id="btn3" class="follow-element"><img class="mail" src="/static/public/Mail.png" alt=""></div></div>
                <div id="4" class="grid-item"><div id="btn4" class="follow-element"><img class="mail" src="/static/public/Mail.png" alt=""></div></div>
                <div id="5" class="grid-item"></div>
                <div id="6" class="grid-item"></div>
                <div id="7" class="grid-item"></div>
                <div id="8" class="grid-item"></div>
                <div id="9" class="grid-item"></div>
                <div id="10" class="grid-item"></div>
                <div id="11" class="grid-item"></div>
                <div id="12" class="grid-item"><div id="btn12" class="solid-element"><img id="send" src="/static/public/Send.png" alt=""></div></div>
                <div id="13" class="grid-item"></div>
                <div id="14" class="grid-item"></div>
                <div id="15" class="grid-item"></div>
                <div id="16" class="grid-item"></div>
                <div id="17" class="grid-item"></div>
                <div id="18" class="grid-item"></div>
                <div id="19" class="grid-item"></div>
                <div id="20" class="grid-item"></div>
                <div id="21" class="grid-item"></div>
                <div id="22" class="grid-item"></div>
                <div id="23" class="grid-item"></div>
                <div id="24" class="grid-item"></div>
                <div id="25" class="grid-item"></div>
                <div id="26" class="grid-item"></div>
                <div id="27" class="grid-item"></div>
                <div id="28" class="grid-item"></div>
                <div id="29" class="grid-item"></div>
                <div id="30" class="grid-item"></div>
                <div id="31" class="grid-item"></div>
                <div id="32" class="grid-item"></div>
                <div id="33" class="grid-item"></div>
                <div id="34" class="grid-item"></div>
                <div id="35" class="grid-item"></div>
                <div id="36" class="grid-item"></div>
                <div id="37" class="grid-item"></div>
                <div id="38" class="grid-item"></div>
                <div id="39" class="grid-item"></div>
                <div id="40" class="grid-item"></div>
                <div id="41" class="grid-item"></div>
                <div id="42" class="grid-item"></div>
                <div id="43" class="grid-item"></div>
                <div id="44" class="grid-item"></div>
                <div id="45" class="grid-item"></div>
                <div id="46" class="grid-item"></div>
                <div id="47" class="grid-item"></div>
                <div id="48" class="grid-item"></div>
                <div id="49" class="grid-item"></div>
                <div id="50" class="grid-item"></div>
                <div id="51" class="grid-item"></div>
                <div id="52" class="grid-item"></div>
                <div id="53" class="grid-item"></div>
                <div id="54" class="grid-item"></div>
                <div id="55" class="grid-item"></div>
                <div id="56" class="grid-item"></div>
                <div id="57" class="grid-item"></div>
                <div id="58" class="grid-item"></div>
                <div id="59" class="grid-item"></div>
                <div id="60" class="grid-item"></div>
                <div id="61" class="grid-item"></div>
                <div id="62" class="grid-item"></div>
                <div id="63" class="grid-item"></div>
                <div id="64" class="grid-item"></div>
                <div id="65" class="grid-item"></div>
                <div id="66" class="grid-item"></div>
                <div id="67" class="grid-item"></div>
                <div id="68" class="grid-item"></div>
                <div id="69" class="grid-item"></div>
                <div id="70" class="grid-item"></div>
                <div id="71" class="grid-item"></div>
                <div id="72" class="grid-item"><div id="btn72" class="solid-element"><img id="recycle" src="/static/public/Recycle.png" alt=""></div></div>
            </div>
            <div id="taskbar">
                <div id="leftborder">
                    <img id="startimg" src="/static/public/Start.png" alt="">
                </div>
                <div id="rightborder">
                    <div id="volumeborder">
                    </div>
                    <div id="moneyborder">
                        <p id="money">0000$</p>
                    </div>
                    <div id="timeborder">
                        <p id="time"></p>
                    </div>
                </div>
            </div>
        </div>
    <script>
var followItems = document.querySelectorAll(".follow-element");
var followPopup = document.querySelectorAll(".borderpopup");
var followPopupHead = document.querySelectorAll(".borderpopuphead")
var garisPopupBody = document.querySelectorAll(".garispopupbody")
var gridTiles = document.querySelectorAll(".grid-item");
var listLine = document.querySelectorAll(".line")
var gridContainer = document.getElementById("grid-container");
var container2 = document.getElementById("container2");
var container1 = document.getElementById("container1");
var cursor = document.getElementById("cursor");
var cursorParent = cursor.parentElement;

function updateClass() {
    followItems = document.querySelectorAll(".follow-element");
    followPopup = document.querySelectorAll(".borderpopup");
    gridTiles = document.querySelectorAll(".grid-item");
    followPopupHead = document.querySelectorAll(".borderpopuphead")
    listLine = document.querySelectorAll(".line")
    attachPopupEventListeners();
}

function displayUserLocalTime() {
    const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const now = new Date().toLocaleString("en-US", { timeZone: userTimezone });
    const date = new Date(now);
    let jam = date.getHours()
    let menit = date.getMinutes()
    if (date.getMinutes() < 10) {
        menit = "0" + date.getMinutes()
    }
    if (date.getHours() < 10) {
        jam = "0" + date.getHours()
    }
    let formatDate = jam + ":" + menit;
    document.getElementById("time").textContent = formatDate;
}
displayUserLocalTime();
setInterval(displayUserLocalTime, 60000);

///////////////
// ITEM AREA //
///////////////

function moveItem(event) {
    if (this.dataset.active === "true") {
        if (onHoldMail == true) {
            let containerRect = gridContainer.getBoundingClientRect(); // Use the main grid container dimensions
            let maxX = containerRect.width - this.offsetWidth;
            let maxY = containerRect.height - (this.offsetHeight + this.parentElement.querySelector(".borderbodypopup").childNodes[1].offsetHeight);

            let newX = Math.min(maxX, Math.max(0, event.clientX - containerRect.left - this.offsetWidth / 2));
            let newY = Math.min(maxY, Math.max(0, event.clientY - containerRect.top - (this.offsetHeight + this.parentElement.querySelector(".borderbodypopup").childNodes[1].offsetHeight) / 20));

            this.parentElement.style.left = newX + "px";
            this.parentElement.style.top = newY + "px";
        } else {
            let containerRect = gridContainer.getBoundingClientRect(); // Use the main grid container dimensions
            let maxX = containerRect.width - this.offsetWidth;
            let maxY = containerRect.height - this.offsetHeight;

            let newX = Math.min(maxX, Math.max(0, event.clientX - containerRect.left - this.offsetWidth / 2));
            let newY = Math.min(maxY, Math.max(0, event.clientY - containerRect.top - this.offsetHeight / 2));

            this.style.left = newX + "px";
            this.style.top = newY + "px";
        }
    }
}
// Move cursor
document.addEventListener("mousemove", function (event) {
    let parentRect = cursorParent.getBoundingClientRect();
    let newX = event.clientX - parentRect.left - cursor.offsetWidth / 2;
    let newY = event.clientY - parentRect.top - cursor.offsetHeight / 2;

    newX = Math.min(Math.max(newX, 0), parentRect.width - cursor.offsetWidth);
    newY = Math.min(Math.max(newY, 0), parentRect.height - cursor.offsetHeight);

    cursor.style.left = newX + "px";
    cursor.style.top = newY + "px";
});
// Hold item
var onHold = false;
var onMove = false;
var onItem = "";
var clickTimeout;
var zIndexPopup = 101

followItems.forEach(function (item) {
    item.addEventListener("mousedown", function (event) {
        clickTimeout = setTimeout(() => {
            onHold = true;
            childParent = item.parentNode.id;
            item.dataset.active = "true";

            if (item.dataset.active == "true") {
                let rect = document.getElementById("1").getBoundingClientRect();
                let height = rect.height;
                let width = rect.width;
                item.style.height = height + "px";
                item.style.width = width + "px";
            }

            item.style.pointerEvents = "none";
            item.style.position = "absolute";

            onItem = item;
        }, 130);
    });

    item.addEventListener("mouseup", function (event) {
        clearTimeout(clickTimeout);
    });
    item.addEventListener("dblclick", function (event) {
        clearTimeout(clickTimeout);
    });
});
// Move item
document.addEventListener("mousemove", function (event) {
    followItems.forEach(function (item) {
        if (onHold == true) {
            onMove = true;
            if (onMove == true) {
                if (onItem.parentElement.id != "grid-container") {
                    gridContainer.appendChild(onItem);
                }
            }
            moveItem.call(item, event);
        }
    });
});
// Drop item
gridTiles.forEach(function (tile) {
    tile.addEventListener("mouseup", function (event) {
        followItems.forEach(function (item) {
            if (item.dataset.active === "true") {
                onHold = false;
                onMove = false;
                onItem = "";
                if (tile.childElementCount != 0) {
                    document.getElementById(childParent).appendChild(item);
                } else {
                    tile.appendChild(item);
                }
                if (tile.id == 12 || tile.id == 72) {
                    let itemID = document.getElementById("popup" + item.id);
                    item.remove();
                    if (itemID) {
                        itemID.remove();
                    }
                }
            }
            item.dataset.active = "false";
            item.style.pointerEvents = "auto";
            item.style.position = "static";
            item.style.height = "100%";
            item.style.width = "100%";
            item.style.removeProperty("top");
            item.style.removeProperty("left");
        });
    });
});

///////////////
// MAIL AREA //
///////////////

// Open mail
function divContent(id, title, sender, receiver, text) {
    return `<div id="${id}" class="borderpopup" style="z-index: ${zIndexPopup + 1}">
                <div class="borderpopuphead">
                    <div class="exitbtnpopup">
                    </div>
                </div>
                <div class="borderbodypopup"">
                    <div class="outerpopupbody"">
                    </div>
                    <div class="innerpopupbody">
                        <div class="garispopuphead">
                            <div class="title">
                                <div class="borderhead">
                                    <p class="realText1">${title}</p>
                                </div>
                            </div>
                            <div class="profile">
                                
                            </div>
                            <div class="sender">
                                <div class="borderhead">
                                    <p class="realText1">${sender}</p>
                                </div>
                            </div>
                            <div class="receiver">
                                <div class="borderhead">
                                    <p class="realText1">${receiver}</p>
                                </div>
                            </div>
                        </div>
                        <div class="garispopupbody">
                            <p class="underlineBG1">${text}</p>
                            <p class="realText1">${text}</p>
                        </div>
                    </div>
                </div>
            </div>`
}

followItems.forEach(function (item) {
    item.addEventListener("dblclick", function (event) {
        let itemID = document.getElementById("popup" + item.id);
        if (!itemID) {
            gridContainer.insertAdjacentHTML('beforeend', divContent("popup" + item.id, "test", "admin", "you", text));
            zIndexPopup++
            //splitTextIntoLines(text, lineLength, "popup" + item.id);
            updateClass()
        } else {
            document.getElementById("popup" + item.id).style.zIndex = zIndexPopup + 1
            zIndexPopup++
        }
    });
});
// Close mail
gridContainer.addEventListener("click", function (event) {
    if (event.target.classList.contains("exitbtnpopup")) {
        event.target.parentElement.parentElement.remove();
    }
});

// Hold mail
var onHoldMail = false;
function attachPopupEventListeners() {
    followPopupHead.forEach(function (item) {
        item.addEventListener("mousedown", function (event) {
            if (!event.target.classList.contains("exitbtnpopup")) {
                onHoldMail = true;
                item.dataset.active = "true";
                item.parentElement.style.zIndex = zIndexPopup + 1
                zIndexPopup++
            }
        });
    });
    // Click mail ontop
    followPopup.forEach(function (item) {
        item.addEventListener("mousedown", function (event) {
            if (onHoldMail == true) {
                return
            }
            item.dataset.active = "true";
            item.style.zIndex = zIndexPopup + 1
            zIndexPopup++
        });
    });
}
// Move mail
document.addEventListener("mousemove", function (event) {
    followPopupHead.forEach(function (item) {
        if (onHoldMail == true) {
            moveItem.call(item, event);
        }
    });
});
// Drop mail
document.addEventListener("mouseup", function (event) {
    followPopupHead.forEach(function (item) {
        onHoldMail = false;
        item.dataset.active = "false";
    });
});
// Active mail
// followPopup.forEach(function (popup) {
//     popup.addEventListener("click", function (item) {
//         console.log(item);
//         updateClass()
//     })
// });

// Add text
const text = "Ad consequat qui pariatur elit ipsum incididunt culpa elit incididunt. Ullamco dolore magna veniam fugiat consectetur. Officia ex pariatur voluptate ut ad anim consectetur voluptate laborum dolor adipisicing officia ut veniam. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Incidunt asperiores eius voluptates ut tempore exercitationem sequi obcaecati nihil adipisci in et quo laborum, expedita quibusdam necessitatibus aliquid, nesciunt dolorem saepe? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Incidunt asperiores eius voluptates ut tempore exercitationem sequi obcaecati nihil adipisci in et quo laborum, expedita.";
const lineLength = 33; // Maximum characters per line

function createLine(text, id) {
    const lineDiv = document.createElement("div")
    lineDiv.className = "line"
    const lineP = document.createElement("p");
    lineP.textContent = text;
    document.getElementById(id).childNodes[3].childNodes[3].childNodes[3].appendChild(lineDiv).appendChild(lineP);
}

function splitTextIntoLines(text, lineLength, id) {
    const words = text.split(" ");
    let currentLine = "";

    words.forEach(word => {
        if ((currentLine + word).length <= lineLength) {
            currentLine += word + " ";
        } else {
            createLine(currentLine.trim(), id);
            currentLine = word + " ";
        }
    });

    if (currentLine.length > 0) {
        createLine(currentLine.trim(), id);
    }
}

attachPopupEventListeners();
    </script>
</body>
</html>
